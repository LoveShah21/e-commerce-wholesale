<!-- Payment Modal Component -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="bi bi-credit-card me-2"></i>Payment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="paymentModalContent">
                    <!-- Payment details will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Preparing payment...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="proceedToPaymentBtn" disabled>
                    <i class="bi bi-arrow-right me-2"></i>Proceed to Payment
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * Show payment modal for an order
     * @param {number} orderId - Order ID
     * @param {string} paymentType - 'advance' or 'final'
     */
    function showPaymentModal(orderId, paymentType) {
        const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const contentDiv = document.getElementById('paymentModalContent');
        const proceedBtn = document.getElementById('proceedToPaymentBtn');

        // Reset modal
        contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading payment details...</p>
        </div>
    `;
        proceedBtn.disabled = true;

        // Show modal
        modal.show();

        // Fetch payment status
        fetch(`/api/payments/status/${orderId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(paymentStatus => {
                const totalAmount = parseFloat(paymentStatus.total_due);
                const paymentAmount = totalAmount * 0.5;

                contentDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>${paymentType === 'advance' ? 'Advance' : 'Final'} Payment</strong>
            </div>
            
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Order ID:</strong>
                        </div>
                        <div class="col-6 text-end">
                            #${orderId}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Total Amount:</strong>
                        </div>
                        <div class="col-6 text-end">
                            ₹${totalAmount.toFixed(2)}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Payment Amount:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span class="text-primary fs-5">₹${paymentAmount.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <strong>Payment Type:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span class="badge bg-info">${paymentType === 'advance' ? 'Advance (50%)' : 'Final (50%)'}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-warning mb-0">
                <small>
                    <i class="bi bi-shield-check me-1"></i>
                    Secure payment powered by Razorpay
                </small>
            </div>
        `;

                proceedBtn.disabled = false;
                proceedBtn.onclick = function () {
                    modal.hide();
                    initiatePayment(orderId, paymentType);
                };
            })
            .catch(error => {
                console.error('Error loading payment details:', error);
                contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Failed to load payment details. Please try again.
            </div>
        `;
            });
    }
</script>