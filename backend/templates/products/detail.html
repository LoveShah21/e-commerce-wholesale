{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.product_name }} - Vaitikan City{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'product-list-web' %}">Products</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ product.product_name }}</li>
    </ol>
</nav>

<div class="row">
    <!-- Product Images -->
    <div class="col-md-6 mb-4">
        <div id="productCarousel" class="carousel slide shadow-sm" data-bs-ride="carousel">
            <div class="carousel-inner rounded">
                {% for image in product.images.all %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <img src="{{ image.image_url }}" class="d-block w-100" alt="{{ image.alt_text }}"
                        style="height: 500px; object-fit: cover;">
                </div>
                {% empty %}
                <div class="carousel-item active">
                    <div class="bg-secondary text-white d-flex justify-content-center align-items-center"
                        style="height: 500px;">
                        <i class="bi bi-image" style="font-size: 5rem;"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if product.images.count > 1 %}
            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>

            <!-- Indicators -->
            <div class="carousel-indicators">
                {% for image in product.images.all %}
                <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active"{% endif %} aria-current="true"
                    aria-label="Slide {{ forloop.counter }}"></button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Product Details -->
    <div class="col-md-6">
        <h1 class="mb-3">{{ product.product_name }}</h1>
        <p class="lead text-muted">{{ product.description }}</p>
        <hr>

        {% if product.variants.exists %}
        <div id="variantSelector">
            <h4 class="mb-3">Select Variant</h4>

            <!-- Variant Selection -->
            <div class="accordion" id="variantsAccordion">
                {% for variant in product.variants.all %}
                <div class="accordion-item mb-2">
                    <h2 class="accordion-header" id="heading{{ variant.id }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse{{ variant.id }}"
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                            aria-controls="collapse{{ variant.id }}">
                            <div class="d-flex justify-content-between w-100 pe-3">
                                <span>
                                    <strong>{{ variant.fabric.fabric_name }}</strong> - {{ variant.color.color_name }}
                                </span>
                                <span class="text-primary">₹{{ variant.base_price }}</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse{{ variant.id }}"
                        class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                        aria-labelledby="heading{{ variant.id }}" data-bs-parent="#variantsAccordion">
                        <div class="accordion-body">
                            <!-- Variant Details -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Pattern:</small>
                                    <p class="mb-1">{{ variant.pattern.pattern_name }}</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Sleeve:</small>
                                    <p class="mb-1">{{ variant.sleeve.sleeve_type }}</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Pocket:</small>
                                    <p class="mb-1">{{ variant.pocket.pocket_type }}</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">SKU:</small>
                                    <p class="mb-1"><code>{{ variant.sku }}</code></p>
                                </div>
                            </div>

                            <!-- Size Selection -->
                            <h6 class="mb-2">Select Size:</h6>
                            <div class="row g-2 mb-3">
                                {% for vsize in variant.sizes.all %}
                                {% with raw_stock=vsize.stock_record.quantity_available|default:0 %}
                                {% with stock=raw_stock|add:0 %}{% comment %}Ensure it's a number{% endcomment %}
                                <div class="col-4">
                                    <input type="radio" class="btn-check" name="variant_size_{{ variant.id }}"
                                        id="size_{{ vsize.id }}" value="{{ vsize.id }}"
                                        data-variant-id="{{ variant.id }}" data-price="{{ variant.base_price }}"
                                        data-stock="{{ stock|default:0 }}" {% if stock <= 0 %}disabled{% endif %}>
                                    <label class="btn btn-outline-primary w-100" for="size_{{ vsize.id }}">
                                        {{ vsize.size.size_code }}
                                        <br>
                                        <small class="{% if stock <= 0 %}text-danger{% elif stock < 5 %}text-warning{% else %}text-success{% endif %}">
                                            {% if stock <= 0 %}
                                            Out of Stock
                                            {% elif stock < 5 and stock > 0 %}Only {{ stock }} left{% else %}In Stock{% endif %}
                                        </small>
                                    </label>
                                </div>
                                {% endwith %}
                                {% endwith %}
                                {% endfor %}
                            </div>

                            <!-- Quantity and Add to Cart -->
                            <div class="row g-2 align-items-end">
                                <div class="col-4">
                                    <label for="quantity_{{ variant.id }}" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="quantity_{{ variant.id }}" value="1"
                                        min="1" max="100">
                                </div>
                                <div class="col-8">
                                    <button class="btn btn-success w-100 add-to-cart-btn"
                                        data-variant-id="{{ variant.id }}" disabled>
                                        <i class="bi bi-cart-plus me-2"></i>Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No variants available for this product at the moment.
        </div>
        {% endif %}

        <!-- Additional Information -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Product Information</h5>
                <ul class="list-unstyled mb-0">
                    <li><i class="bi bi-check-circle text-success me-2"></i>Premium quality fabric</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Custom sizing available</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Bulk orders accepted</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Fast delivery</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cart.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle size selection
        document.querySelectorAll('input[type="radio"][name^="variant_size_"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const variantId = this.dataset.variantId;
                const addToCartBtn = document.querySelector(`.add-to-cart-btn[data-variant-id="${variantId}"]`);
                addToCartBtn.disabled = false;

                // Update price display with dynamic calculation
                updatePriceDisplay(variantId, this);
            });
        });

        // Handle quantity change for dynamic price calculation
        document.querySelectorAll('input[id^="quantity_"]').forEach(input => {
            input.addEventListener('input', function () {
                const variantId = this.id.replace('quantity_', '');
                const selectedSize = document.querySelector(`input[name="variant_size_${variantId}"]:checked`);
                if (selectedSize) {
                    updatePriceDisplay(variantId, selectedSize);
                }
            });
        });

        // Handle add to cart
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const variantId = this.dataset.variantId;
                const selectedSize = document.querySelector(`input[name="variant_size_${variantId}"]:checked`);

                if (!selectedSize) {
                    VaitikanApp.showToast('Please select a size', 'warning');
                    return;
                }

                const variantSizeId = selectedSize.value;
                const quantityInput = document.getElementById(`quantity_${variantId}`);
                const quantity = quantityInput.value;

                // Validate quantity
                const validation = CartModule.validateQuantity(quantity, parseInt(selectedSize.dataset.stock));
                if (!validation.isValid) {
                    VaitikanApp.showToast(validation.message, 'error');
                    return;
                }

                try {
                    await CartModule.addToCart(variantSizeId, quantity);
                    // Reset quantity to 1 after successful add
                    quantityInput.value = 1;
                    // Uncheck size selection
                    selectedSize.checked = false;
                    this.disabled = true;
                } catch (error) {
                    console.error('Add to cart error:', error);
                    // Ensure loading is hidden in case of error
                    if (window.VaitikanApp) {
                        window.VaitikanApp.hideLoading();
                    }
                    VaitikanApp.showToast(error.message || 'Failed to add item to cart', 'error');
                }
            });
        });

        function updatePriceDisplay(variantId, sizeRadio) {
            const price = parseFloat(sizeRadio.dataset.price);
            const quantityInput = document.getElementById(`quantity_${variantId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            const total = price * quantity;

            // Find or create price display element
            let priceDisplay = document.querySelector(`#price-display-${variantId}`);
            if (!priceDisplay) {
                const addToCartBtn = document.querySelector(`.add-to-cart-btn[data-variant-id="${variantId}"]`);
                priceDisplay = document.createElement('div');
                priceDisplay.id = `price-display-${variantId}`;
                priceDisplay.className = 'alert alert-info mt-2 mb-0';
                addToCartBtn.parentNode.parentNode.appendChild(priceDisplay);
            }

            priceDisplay.innerHTML = `
                <strong>Total:</strong> ${CartModule.formatPrice(total)}
                <small class="d-block text-muted">${CartModule.formatPrice(price)} × ${quantity}</small>
            `;
        }

        // Real-time stock checking for selected sizes
        let stockCheckInterval;
        document.querySelectorAll('input[type="radio"][name^="variant_size_"]').forEach(radio => {
            radio.addEventListener('change', function () {
                // Clear previous interval
                if (stockCheckInterval) {
                    clearInterval(stockCheckInterval);
                }

                const variantSizeId = this.value;
                const stockDisplay = this.parentElement.querySelector('small');

                // Check stock every 15 seconds
                stockCheckInterval = setInterval(async () => {
                    try {
                        const stock = await CartModule.checkStockAvailability(variantSizeId);
                        const available = Math.max(0, stock.available || 0); // Ensure non-negative

                        // Update stock display
                        if (available <= 0) {
                            stockDisplay.className = 'text-danger';
                            stockDisplay.textContent = 'Out of Stock';
                            this.disabled = true;
                        } else if (available < 5) {
                            stockDisplay.className = 'text-warning';
                            stockDisplay.textContent = `Only ${available} left`;
                        } else {
                            stockDisplay.className = 'text-success';
                            stockDisplay.textContent = 'In Stock';
                        }

                        // Update data attribute
                        this.dataset.stock = available;
                    } catch (error) {
                        console.error('Stock check error:', error);
                    }
                }, 15000);
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function () {
            if (stockCheckInterval) {
                clearInterval(stockCheckInterval);
            }
        });
    });
</script>
{% endblock %}

