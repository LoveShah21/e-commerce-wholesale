{% extends 'base.html' %}

{% block title %}Checkout - Vaitikan City{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="bi bi-credit-card me-2"></i>Checkout</h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Delivery Address -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Delivery Address</h5>
            </div>
            <div class="card-body">
                <div id="addressList">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <button class="btn btn-outline-primary mt-3" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                    <i class="bi bi-plus-circle me-2"></i>Add New Address
                </button>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Order Items</h5>
            </div>
            <div class="card-body" id="orderItemsContainer">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Order Summary -->
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="orderSubtotal">₹0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tax (GST 18%):</span>
                    <span id="orderTax">₹0.00</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <strong>Total:</strong>
                    <strong class="text-success fs-4" id="orderTotal">₹0.00</strong>
                </div>
                <div class="alert alert-info" role="alert">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        50% advance payment required
                    </small>
                </div>
                <button class="btn btn-success w-100" id="placeOrderBtn" disabled>
                    <i class="bi bi-check-circle me-2"></i>Place Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAddressForm">
                    <div class="mb-3">
                        <label for="addressLine1" class="form-label">Address Line 1 *</label>
                        <input type="text" class="form-control" id="addressLine1" required>
                    </div>
                    <div class="mb-3">
                        <label for="addressLine2" class="form-label">Address Line 2</label>
                        <input type="text" class="form-control" id="addressLine2">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="city" class="form-label">City *</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="state" class="form-label">State *</label>
                            <input type="text" class="form-control" id="state" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="postalCode" class="form-label">Postal Code *</label>
                            <input type="text" class="form-control" id="postalCode" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="country" class="form-label">Country *</label>
                            <input type="text" class="form-control" id="country" value="India" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAddressBtn">Save Address</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedAddressId = null;
    let cartData = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadAddresses();
        loadCart();

        document.getElementById('saveAddressBtn').addEventListener('click', saveAddress);
        document.getElementById('placeOrderBtn').addEventListener('click', placeOrder);
    });

    function loadAddresses() {
        fetch('/api/users/addresses/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(addresses => {
                renderAddresses(addresses);
            })
            .catch(error => {
                console.error('Error loading addresses:', error);
                document.getElementById('addressList').innerHTML = `
            <div class="alert alert-warning" role="alert">
                No addresses found. Please add a delivery address.
            </div>
        `;
            });
    }

    function renderAddresses(addresses) {
        const container = document.getElementById('addressList');

        if (!addresses || addresses.length === 0) {
            container.innerHTML = `
            <div class="alert alert-warning" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                No addresses found. Please add a delivery address.
            </div>
        `;
            return;
        }

        let html = '<div class="list-group">';
        addresses.forEach((address, index) => {
            html += `
            <label class="list-group-item">
                <input class="form-check-input me-2" type="radio" name="deliveryAddress" 
                       value="${address.id}" ${index === 0 ? 'checked' : ''}
                       onchange="selectAddress(${address.id})">
                <div class="ms-2">
                    <strong>${address.address_line_1}</strong>
                    ${address.address_line_2 ? `<br>${address.address_line_2}` : ''}
                    <br>${address.city.city_name}, ${address.state.state_name} - ${address.postal_code.postal_code}
                    <br>${address.country.country_name}
                </div>
            </label>
        `;
        });
        html += '</div>';

        container.innerHTML = html;

        // Select first address by default
        if (addresses.length > 0) {
            selectedAddressId = addresses[0].id;
            updatePlaceOrderButton();
        }
    }

    function selectAddress(addressId) {
        selectedAddressId = addressId;
        updatePlaceOrderButton();
    }

    function loadCart() {
        fetch('/api/cart/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                cartData = data;
                renderOrderItems(data);
                updateOrderSummary(data);
            })
            .catch(error => {
                console.error('Error loading cart:', error);
                document.getElementById('orderItemsContainer').innerHTML = `
            <div class="alert alert-danger" role="alert">
                Failed to load cart items.
            </div>
        `;
            });
    }

    function renderOrderItems(cart) {
        const container = document.getElementById('orderItemsContainer');

        if (!cart.items || cart.items.length === 0) {
            container.innerHTML = `
            <div class="alert alert-warning" role="alert">
                Your cart is empty. <a href="/products/">Browse products</a>
            </div>
        `;
            return;
        }

        let html = '<div class="list-group">';
        cart.items.forEach(item => {
            const product = item.variant_size.variant.product;
            const variant = item.variant_size.variant;
            const size = item.variant_size.size;
            const price = parseFloat(variant.base_price);
            const total = price * item.quantity;

            html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${product.product_name}</h6>
                        <small class="text-muted">
                            ${variant.fabric.fabric_name} - ${variant.color.color_name} | Size: ${size.size_code}
                        </small>
                        <br>
                        <small>Quantity: ${item.quantity} × ₹${price.toFixed(2)}</small>
                    </div>
                    <strong>₹${total.toFixed(2)}</strong>
                </div>
            </div>
        `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    function updateOrderSummary(cart) {
        const subtotal = cart.items.reduce((sum, item) => {
            return sum + (parseFloat(item.variant_size.variant.base_price) * item.quantity);
        }, 0);

        const taxRate = 0.18;
        const tax = subtotal * taxRate;
        const total = subtotal + tax;

        document.getElementById('orderSubtotal').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('orderTax').textContent = `₹${tax.toFixed(2)}`;
        document.getElementById('orderTotal').textContent = `₹${total.toFixed(2)}`;
    }

    function updatePlaceOrderButton() {
        const btn = document.getElementById('placeOrderBtn');
        btn.disabled = !selectedAddressId || !cartData || !cartData.items || cartData.items.length === 0;
    }

    function saveAddress() {
        const addressData = {
            address_line_1: document.getElementById('addressLine1').value,
            address_line_2: document.getElementById('addressLine2').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            postal_code: document.getElementById('postalCode').value,
            country: document.getElementById('country').value
        };

        fetch('/api/users/addresses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(addressData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                VaitikanApp.showToast('Address added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addAddressModal')).hide();
                document.getElementById('addAddressForm').reset();
                loadAddresses();
            })
            .catch(error => {
                const message = error.detail || error.message || 'Failed to add address';
                VaitikanApp.showToast(message, 'error');
            });
    }

    function placeOrder() {
        if (!selectedAddressId) {
            VaitikanApp.showToast('Please select a delivery address', 'warning');
            return;
        }

        VaitikanApp.showLoading('Placing your order...');

        fetch('/api/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                delivery_address: selectedAddressId
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                VaitikanApp.hideLoading();
                VaitikanApp.showToast('Order placed successfully!', 'success');
                // Redirect to payment page
                setTimeout(() => {
                    window.location.href = `/payments/order/${data.id}/`;
                }, 1500);
            })
            .catch(error => {
                VaitikanApp.hideLoading();
                const message = error.detail || error.message || 'Failed to place order';
                VaitikanApp.showToast(message, 'error');
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}