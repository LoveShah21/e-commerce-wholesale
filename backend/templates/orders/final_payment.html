{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>Final Payment - Order #{{ order.id }}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Order Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Order Details</h5>
                            <p><strong>Order ID:</strong> #{{ order.id }}</p>
                            <p><strong>Order Date:</strong> {{ order.order_date|date:"F d, Y" }}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge bg-info">{{ order.status|title }}</span>
                            </p>
                            <p><strong>Items:</strong> {{ order.items.count }} item{{ order.items.count|pluralize }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Payment Summary</h5>
                            <p><strong>Total Amount:</strong> ₹{{ order.total_amount }}</p>
                            <p><strong>Advance Paid:</strong> 
                                <span class="text-success">₹{{ advance_payment.amount }}</span>
                                <i class="bi bi-check-circle text-success ms-1"></i>
                            </p>
                            <p><strong>Final Payment:</strong> 
                                <span class="text-primary fw-bold">₹{{ final_payment.amount }}</span>
                            </p>
                        </div>
                    </div>

                    <!-- Payment Status -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Ready for Final Payment!</strong> 
                        Your order is ready for dispatch. Complete the final payment to proceed with shipping.
                    </div>

                    <!-- Order Items -->
                    <div class="mb-4">
                        <h5>Order Items</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Details</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in order.items.all %}
                                    <tr>
                                        <td>{{ item.variant_size.variant.product.product_name }}</td>
                                        <td>
                                            {{ item.variant_size.variant.color.color_name }} - 
                                            {{ item.variant_size.size.size_code }}
                                        </td>
                                        <td>{{ item.quantity }}</td>
                                        <td>₹{{ item.line_total }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Payment Button -->
                    <div class="text-center">
                        {% if final_payment.payment_status == 'initiated' %}
                        <button id="payNowBtn" class="btn btn-success btn-lg">
                            <i class="bi bi-credit-card me-2"></i>
                            Pay ₹{{ final_payment.amount }} Now
                        </button>
                        <p class="text-muted mt-2">
                            <small>Secure payment powered by Razorpay</small>
                        </p>
                        {% elif final_payment.payment_status == 'pending' %}
                        <div class="alert alert-warning">
                            <i class="bi bi-clock me-2"></i>
                            Payment is being processed. Please wait...
                        </div>
                        {% elif final_payment.payment_status == 'failed' %}
                        <button id="retryPaymentBtn" class="btn btn-warning btn-lg">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Retry Payment - ₹{{ final_payment.amount }}
                        </button>
                        <div class="alert alert-danger mt-2">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Previous payment failed. Please try again.
                        </div>
                        {% endif %}
                    </div>

                    <!-- Delivery Address -->
                    <div class="mt-4">
                        <h5>Delivery Address</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-1">{{ order.delivery_address.address_line1 }}</p>
                                {% if order.delivery_address.address_line2 %}
                                <p class="mb-1">{{ order.delivery_address.address_line2 }}</p>
                                {% endif %}
                                <p class="mb-0">
                                    {{ order.delivery_address.postal_code.city.city_name }}, 
                                    {{ order.delivery_address.postal_code.city.state.state_name }} 
                                    {{ order.delivery_address.postal_code.postal_code }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Back Button -->
                    <div class="mt-4 text-center">
                        <a href="{% url 'order-list-web' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 mb-0">Processing payment...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const payNowBtn = document.getElementById('payNowBtn');
    const retryPaymentBtn = document.getElementById('retryPaymentBtn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    function initiatePayment() {
        loadingModal.show();
        
        const options = {
            "key": "{{ razorpay_key_id }}", // Will be passed from backend
            "amount": {{ final_payment.amount|floatformat:2 }} * 100, // Amount in paise
            "currency": "INR",
            "name": "Vaitikan City",
            "description": "Final Payment - Order #{{ order.id }}",
            "order_id": "{{ final_payment.razorpay_order_id }}",
            "handler": function (response) {
                // Payment successful
                loadingModal.hide();
                
                // Send payment details to backend for verification
                fetch('/api/payments/verify/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        payment_id: {{ final_payment.id }},
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Payment verification failed: ' + data.error);
                    } else {
                        // Success - redirect to order tracking page
                        alert('Payment successful! Your order will be dispatched soon.');
                        window.location.href = '/order-tracking/{{ order.id }}/';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Payment verification failed. Please contact support.');
                });
            },
            "prefill": {
                "name": "{{ order.user.full_name }}",
                "email": "{{ order.user.email }}",
                "contact": "{{ order.user.phone }}"
            },
            "theme": {
                "color": "#007bff"
            },
            "modal": {
                "ondismiss": function() {
                    loadingModal.hide();
                }
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
    }

    if (payNowBtn) {
        payNowBtn.addEventListener('click', initiatePayment);
    }
    
    if (retryPaymentBtn) {
        retryPaymentBtn.addEventListener('click', initiatePayment);
    }
});
</script>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}