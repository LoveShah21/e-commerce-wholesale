{% extends 'base.html' %}

{% block title %}Order Tracking - Vaitikan City{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'order-list-web' %}">My Orders</a></li>
                <li class="breadcrumb-item active" aria-current="page">Order Tracking</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Order Details</h5>
            </div>
            <div class="card-body" id="orderDetailsContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Order Items -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Order Items</h5>
            </div>
            <div class="card-body" id="orderItemsContainer">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delivery Address -->
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Delivery Address</h5>
            </div>
            <div class="card-body" id="deliveryAddressContainer">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Order Status Timeline -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Order Status</h5>
            </div>
            <div class="card-body" id="orderStatusContainer">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment</h5>
            </div>
            <div class="card-body" id="paymentContainer">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complaint Section -->
        <div class="card shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Need Help?</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Having issues with your order? Let us know and we'll help resolve it quickly.</p>
                
                <!-- Existing Complaints -->
                <div id="existingComplaints" style="display: none;">
                    <h6 class="mb-3">Your Complaints</h6>
                    <div id="complaintsContainer"></div>
                    <hr>
                </div>

                <!-- Complaint Form -->
                <div id="complaintFormContainer">
                    <button class="btn btn-outline-danger w-100" onclick="showComplaintForm()">
                        <i class="bi bi-plus-circle me-2"></i>Report an Issue
                    </button>
                    
                    <div id="complaintForm" style="display: none;" class="mt-3">
                        <form id="submitComplaintForm">
                            <div class="mb-3">
                                <label for="complaintCategory" class="form-label">Issue Category</label>
                                <select class="form-select" id="complaintCategory" required>
                                    <option value="">Select category...</option>
                                    <option value="Quality Issue">Quality Issue</option>
                                    <option value="Delivery Delay">Delivery Delay</option>
                                    <option value="Wrong Item">Wrong Item Received</option>
                                    <option value="Damaged Item">Damaged Item</option>
                                    <option value="Size Issue">Size Issue</option>
                                    <option value="Color Issue">Color Issue</option>
                                    <option value="Customer Service">Customer Service</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="complaintDescription" class="form-label">Describe the Issue</label>
                                <textarea class="form-control" id="complaintDescription" rows="4" 
                                    placeholder="Please provide details about the issue you're experiencing..." required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-send me-2"></i>Submit Complaint
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="hideComplaintForm()">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- View All Complaints Link -->
                <div class="mt-3 text-center">
                    <a href="/complaints/" class="btn btn-link">
                        <i class="bi bi-list-ul me-1"></i>View All My Complaints
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="/static/js/payment.js"></script>
<script>
    const orderId = window.location.pathname.split('/').filter(Boolean).pop();

    document.addEventListener('DOMContentLoaded', function () {
        loadOrderDetails();
        loadOrderComplaints();
    });

    function loadOrderDetails() {
        fetch(`/api/orders/${orderId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                return response.json();
            })
            .then(order => {
                renderOrderDetails(order);
                renderOrderItems(order.items);
                renderDeliveryAddress(order.delivery_address);
                renderOrderStatus(order.status);
                renderPaymentInfo(order);
            })
            .catch(error => {
                console.error('Error loading order:', error);
                document.getElementById('orderDetailsContainer').innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Failed to load order details. Please try again.
            </div>
        `;
            });
    }

    function renderOrderDetails(order) {
        const container = document.getElementById('orderDetailsContainer');
        const orderDate = new Date(order.order_date).toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        const statusBadgeClass = {
            'pending': 'bg-warning',
            'confirmed': 'bg-info',
            'processing': 'bg-primary',
            'dispatched': 'bg-success',
            'delivered': 'bg-success',
            'cancelled': 'bg-danger'
        }[order.status] || 'bg-secondary';

        container.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <p class="mb-1"><strong>Order ID:</strong></p>
                <p class="text-muted">#${order.id}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-1"><strong>Order Date:</strong></p>
                <p class="text-muted">${orderDate}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-1"><strong>Status:</strong></p>
                <span class="badge ${statusBadgeClass}">${order.status.toUpperCase()}</span>
            </div>
            <div class="col-md-3">
                <p class="mb-1"><strong>Total Amount:</strong></p>
                <p class="text-success fs-5 mb-0">₹${parseFloat(order.total_amount).toFixed(2)}</p>
            </div>
        </div>
        ${order.notes ? `
            <hr>
            <p class="mb-1"><strong>Order Notes:</strong></p>
            <p class="text-muted">${order.notes}</p>
        ` : ''}
    `;
    }

    function renderOrderItems(items) {
        const container = document.getElementById('orderItemsContainer');

        let html = '<div class="table-responsive"><table class="table align-middle">';
        html += '<thead><tr><th>Product</th><th>Quantity</th><th>Price</th><th>Total</th></tr></thead>';
        html += '<tbody>';

        items.forEach(item => {
            const product = item.variant_size.variant.product;
            const variant = item.variant_size.variant;
            const size = item.variant_size.size;
            const price = parseFloat(item.snapshot_unit_price);
            const total = price * item.quantity;

            html += `
            <tr>
                <td>
                    <div>
                        <h6 class="mb-1">${product.product_name}</h6>
                        <small class="text-muted">
                            ${variant.fabric.fabric_name} - ${variant.color.color_name}<br>
                            Size: ${size.size_code}
                        </small>
                    </div>
                </td>
                <td>${item.quantity}</td>
                <td>₹${price.toFixed(2)}</td>
                <td><strong>₹${total.toFixed(2)}</strong></td>
            </tr>
        `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function renderDeliveryAddress(address) {
        const container = document.getElementById('deliveryAddressContainer');

        container.innerHTML = `
        <address class="mb-0">
            <strong>${address.address_line_1}</strong><br>
            ${address.address_line_2 ? address.address_line_2 + '<br>' : ''}
            ${address.city.city_name}, ${address.state.state_name}<br>
            ${address.postal_code.postal_code}<br>
            ${address.country.country_name}
        </address>
    `;
    }

    function renderOrderStatus(status) {
        const container = document.getElementById('orderStatusContainer');

        const statuses = [
            { key: 'pending', label: 'Order Placed', icon: 'check-circle' },
            { key: 'confirmed', label: 'Confirmed', icon: 'check-circle-fill' },
            { key: 'processing', label: 'Processing', icon: 'gear-fill' },
            { key: 'dispatched', label: 'Dispatched', icon: 'truck' },
            { key: 'delivered', label: 'Delivered', icon: 'box-seam' }
        ];

        const currentIndex = statuses.findIndex(s => s.key === status);

        let html = '<div class="timeline">';
        statuses.forEach((s, index) => {
            const isCompleted = index <= currentIndex;
            const isCurrent = index === currentIndex;

            html += `
            <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
                <div class="timeline-marker">
                    <i class="bi bi-${s.icon}"></i>
                </div>
                <div class="timeline-content">
                    <h6 class="mb-0">${s.label}</h6>
                </div>
            </div>
        `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    function renderPaymentInfo(order) {
        const container = document.getElementById('paymentContainer');

        // Fetch payment status
        fetch(`/api/payments/status/${orderId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(paymentStatus => {
                const totalAmount = parseFloat(paymentStatus.total_due);
                const totalPaid = parseFloat(paymentStatus.total_paid);
                const balanceDue = totalAmount - totalPaid;

                let html = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Amount:</span>
                        <strong>₹${totalAmount.toFixed(2)}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Amount Paid:</span>
                        <span class="text-success">₹${totalPaid.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Balance Due:</span>
                        <span class="${balanceDue > 0 ? 'text-danger' : 'text-success'}">
                            ₹${balanceDue.toFixed(2)}
                        </span>
                    </div>
                </div>
            `;

                // Show payment buttons based on status
                if (!paymentStatus.advance_paid) {
                    html += `
                    <div class="alert alert-warning" role="alert">
                        <small><i class="bi bi-info-circle me-1"></i>Advance payment (50%) required to confirm order</small>
                    </div>
                    <button class="btn btn-primary w-100 mb-2" onclick="initiatePayment(${orderId}, 'advance')">
                        <i class="bi bi-credit-card me-2"></i>Pay Advance (50%)
                    </button>
                `;
                } else if (!paymentStatus.final_paid && order.status === 'dispatched') {
                    html += `
                    <div class="alert alert-info" role="alert">
                        <small><i class="bi bi-info-circle me-1"></i>Final payment (50%) required before delivery</small>
                    </div>
                    <button class="btn btn-success w-100 mb-2" onclick="initiatePayment(${orderId}, 'final')">
                        <i class="bi bi-credit-card me-2"></i>Pay Final Amount (50%)
                    </button>
                `;
                } else if (paymentStatus.fully_paid) {
                    html += `
                    <div class="alert alert-success" role="alert">
                        <small><i class="bi bi-check-circle me-1"></i>All payments completed</small>
                    </div>
                `;
                }

                html += `
                <a href="/payments/history/?order_id=${orderId}" class="btn btn-outline-secondary w-100 mb-2">
                    <i class="bi bi-clock-history me-2"></i>Payment History
                </a>
            `;

                // Add invoice buttons if advance payment is made
                if (paymentStatus.advance_paid) {
                    html += `
                    <hr class="my-3">
                    <h6 class="mb-2"><i class="bi bi-file-earmark-text me-1"></i>Invoice</h6>
                    <a href="/invoices/${orderId}/preview/" class="btn btn-outline-primary w-100 mb-2" target="_blank">
                        <i class="bi bi-eye me-2"></i>Preview Invoice
                    </a>
                    <a href="/api/invoices/${orderId}/download/" class="btn btn-primary w-100" target="_blank">
                        <i class="bi bi-download me-2"></i>Download PDF
                    </a>
                `;
                }

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading payment status:', error);
                container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <small>Failed to load payment information</small>
                </div>
            `;
            });
    }

    function loadOrderComplaints() {
        fetch(`/api/support/complaints/?order_id=${orderId}`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(complaints => {
            if (complaints.length > 0) {
                renderExistingComplaints(complaints);
            }
        })
        .catch(error => {
            console.error('Error loading complaints:', error);
        });
    }

    function renderExistingComplaints(complaints) {
        const container = document.getElementById('complaintsContainer');
        const existingSection = document.getElementById('existingComplaints');
        
        let html = '';
        complaints.forEach(complaint => {
            const statusBadge = {
                'open': 'bg-warning text-dark',
                'in_progress': 'bg-info',
                'resolved': 'bg-success',
                'closed': 'bg-secondary'
            }[complaint.status] || 'bg-secondary';

            const date = new Date(complaint.complaint_date).toLocaleDateString('en-IN');

            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">Complaint #${complaint.id}</h6>
                            <span class="badge ${statusBadge}">${complaint.status.replace('_', ' ').toUpperCase()}</span>
                        </div>
                        <p class="text-muted mb-1"><strong>Category:</strong> ${complaint.complaint_category}</p>
                        <p class="text-muted mb-1"><strong>Date:</strong> ${date}</p>
                        <p class="mb-2">${complaint.complaint_description.substring(0, 100)}${complaint.complaint_description.length > 100 ? '...' : ''}</p>
                        ${complaint.resolution_notes ? `
                            <div class="alert alert-info p-2 mb-0">
                                <small><strong>Resolution:</strong> ${complaint.resolution_notes}</small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        existingSection.style.display = 'block';
    }

    function showComplaintForm() {
        document.getElementById('complaintForm').style.display = 'block';
        document.querySelector('button[onclick="showComplaintForm()"]').style.display = 'none';
    }

    function hideComplaintForm() {
        document.getElementById('complaintForm').style.display = 'none';
        document.querySelector('button[onclick="showComplaintForm()"]').style.display = 'block';
    }

    // Handle complaint form submission
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('submitComplaintForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const category = document.getElementById('complaintCategory').value;
            const description = document.getElementById('complaintDescription').value;
            
            if (!category || !description.trim()) {
                alert('Please fill in all required fields.');
                return;
            }

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Submitting...';
            submitBtn.disabled = true;

            // Submit complaint
            fetch('/api/support/complaints/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    order: orderId,
                    complaint_category: category,
                    complaint_description: description
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to submit complaint');
                }
                return response.json();
            })
            .then(complaint => {
                // Show success message
                if (typeof VaitikanApp !== 'undefined' && VaitikanApp.showToast) {
                    VaitikanApp.showToast('Complaint submitted successfully! We will review it shortly.', 'success');
                } else {
                    alert('Complaint submitted successfully! We will review it shortly.');
                }
                
                // Reset form and hide it
                this.reset();
                hideComplaintForm();
                
                // Reload complaints
                loadOrderComplaints();
            })
            .catch(error => {
                console.error('Error submitting complaint:', error);
                if (typeof VaitikanApp !== 'undefined' && VaitikanApp.showToast) {
                    VaitikanApp.showToast('Failed to submit complaint. Please try again.', 'error');
                } else {
                    alert('Failed to submit complaint. Please try again.');
                }
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    .timeline {
        position: relative;
        padding-left: 40px;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 30px;
    }

    .timeline-item:not(:last-child)::before {
        content: '';
        position: absolute;
        left: -25px;
        top: 30px;
        width: 2px;
        height: calc(100% - 10px);
        background-color: #dee2e6;
    }

    .timeline-item.completed:not(:last-child)::before {
        background-color: #198754;
    }

    .timeline-marker {
        position: absolute;
        left: -35px;
        top: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .timeline-item.completed .timeline-marker {
        background-color: #198754;
    }

    .timeline-item.current .timeline-marker {
        background-color: #0d6efd;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
        }

        50% {
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }
    }

    .timeline-content h6 {
        font-size: 0.9rem;
    }

    .timeline-item.completed .timeline-content h6 {
        color: #198754;
    }

    .timeline-item.current .timeline-content h6 {
        color: #0d6efd;
        font-weight: bold;
    }
</style>
{% endblock %}