{% extends 'base.html' %}

{% block title %}Shopping Cart - Vaitikan City{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="bi bi-cart3 me-2"></i>Shopping Cart</h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body" id="cartItemsContainer">
                <!-- Cart items will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Cart Summary -->
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">₹0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tax (GST):</span>
                    <span id="cartTax">₹0.00</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <strong>Total:</strong>
                    <strong class="text-primary fs-4" id="cartTotal">₹0.00</strong>
                </div>
                <button class="btn btn-success w-100 mb-2" id="checkoutBtn" disabled>
                    <i class="bi bi-credit-card me-2"></i>Proceed to Checkout
                </button>
                <a href="{% url 'product-list-web' %}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadCart();

        document.getElementById('checkoutBtn').addEventListener('click', function () {
            window.location.href = '/checkout/';
        });
    });

    function loadCart() {
        fetch('/api/cart/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                renderCart(data);
            })
            .catch(error => {
                console.error('Error loading cart:', error);
                document.getElementById('cartItemsContainer').innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Failed to load cart. Please try again.
            </div>
        `;
            });
    }

    function renderCart(cart) {
        const container = document.getElementById('cartItemsContainer');

        if (!cart.items || cart.items.length === 0) {
            container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3">Your cart is empty</h4>
                <p class="text-muted">Add some products to get started!</p>
                <a href="/products/" class="btn btn-primary mt-3">
                    <i class="bi bi-shop me-2"></i>Browse Products
                </a>
            </div>
        `;
            document.getElementById('checkoutBtn').disabled = true;
            return;
        }

        let html = '<div class="table-responsive"><table class="table align-middle">';
        html += '<thead><tr><th>Product</th><th>Price</th><th>Quantity</th><th>Total</th><th>Action</th></tr></thead>';
        html += '<tbody>';

        cart.items.forEach(item => {
            const product = item.variant_size.variant.product;
            const variant = item.variant_size.variant;
            const size = item.variant_size.size;
            const price = parseFloat(item.variant_size.variant.base_price);
            const total = price * item.quantity;
            const stock = item.variant_size.stock_record?.quantity_available || 0;

            html += `
            <tr data-item-id="${item.id}">
                <td>
                    <div class="d-flex align-items-center">
                        ${product.images && product.images.length > 0 ?
                    `<img src="${product.images[0].image_url}" alt="${product.product_name}" 
                                  class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover;">` :
                    `<div class="bg-secondary rounded me-3 d-flex align-items-center justify-content-center" 
                                  style="width: 80px; height: 80px;">
                                <i class="bi bi-image text-white"></i>
                             </div>`
                }
                        <div>
                            <h6 class="mb-1">${product.product_name}</h6>
                            <small class="text-muted">
                                ${variant.fabric.fabric_name} - ${variant.color.color_name}<br>
                                Size: ${size.size_code}
                            </small>
                        </div>
                    </div>
                </td>
                <td>₹${price.toFixed(2)}</td>
                <td>
                    <div class="input-group" style="width: 130px;">
                        <button class="btn btn-outline-secondary btn-sm" type="button" 
                                onclick="updateQuantity(${item.id}, ${item.quantity - 1}, ${stock})">
                            <i class="bi bi-dash"></i>
                        </button>
                        <input type="number" class="form-control form-control-sm text-center" 
                               value="${item.quantity}" min="1" max="${stock}"
                               onchange="updateQuantity(${item.id}, this.value, ${stock})">
                        <button class="btn btn-outline-secondary btn-sm" type="button" 
                                onclick="updateQuantity(${item.id}, ${item.quantity + 1}, ${stock})">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">${stock} available</small>
                </td>
                <td><strong>₹${total.toFixed(2)}</strong></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

        // Update summary
        updateSummary(cart);
        document.getElementById('checkoutBtn').disabled = false;
    }

    function updateSummary(cart) {
        const subtotal = cart.items.reduce((sum, item) => {
            return sum + (parseFloat(item.variant_size.variant.base_price) * item.quantity);
        }, 0);

        const taxRate = 0.18; // 18% GST
        const tax = subtotal * taxRate;
        const total = subtotal + tax;

        document.getElementById('cartSubtotal').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('cartTax').textContent = `₹${tax.toFixed(2)}`;
        document.getElementById('cartTotal').textContent = `₹${total.toFixed(2)}`;
    }

    function updateQuantity(itemId, newQuantity, maxStock) {
        newQuantity = parseInt(newQuantity);

        if (newQuantity < 1) {
            VaitikanApp.showToast('Quantity must be at least 1', 'warning');
            return;
        }

        if (newQuantity > maxStock) {
            VaitikanApp.showToast(`Only ${maxStock} items available in stock`, 'error');
            return;
        }

        fetch(`/api/cart-items/${itemId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ quantity: newQuantity })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                VaitikanApp.showToast('Cart updated', 'success');
                loadCart();
            })
            .catch(error => {
                const message = error.detail || error.message || 'Failed to update quantity';
                VaitikanApp.showToast(message, 'error');
                loadCart();
            });
    }

    function removeItem(itemId) {
        VaitikanApp.showDeleteConfirm('Are you sure you want to remove this item from your cart?', function () {
            fetch(`/api/cart-items/${itemId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => {
                    if (response.ok) {
                        VaitikanApp.showToast('Item removed from cart', 'success');
                        loadCart();
                    } else {
                        throw new Error('Failed to remove item');
                    }
                })
                .catch(error => {
                    VaitikanApp.showToast('Failed to remove item', 'error');
                });
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}