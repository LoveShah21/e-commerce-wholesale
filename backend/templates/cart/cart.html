{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Vaitikan City{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="bi bi-cart3 me-2"></i>Shopping Cart</h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body" id="cartItemsContainer">
                <!-- Cart items will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Cart Summary -->
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">₹0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tax (GST):</span>
                    <span id="cartTax">₹0.00</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <strong>Total:</strong>
                    <strong class="text-primary fs-4" id="cartTotal">₹0.00</strong>
                </div>
                <button class="btn btn-success w-100 mb-2" id="checkoutBtn" disabled>
                    <i class="bi bi-credit-card me-2"></i>Proceed to Checkout
                </button>
                <a href="{% url 'product-list-web' %}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cart.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadCart();

        // Start stock monitoring for cart items
        CartModule.startStockMonitoring(30000); // Check every 30 seconds

        // Handle checkout button
        document.getElementById('checkoutBtn').addEventListener('click', async function () {
            // Validate cart before checkout
            const validation = await CartModule.validateCartForCheckout();

            if (!validation.isValid) {
                VaitikanApp.showToast(validation.message, 'error');
                if (validation.details) {
                    // Show detailed error messages
                    setTimeout(() => {
                        validation.details.forEach(detail => {
                            VaitikanApp.showToast(detail, 'warning', 5000);
                        });
                    }, 500);
                }
                // Reload cart to show updated stock
                loadCart();
                return;
            }

            window.location.href = '/checkout/';
        });

        // Listen for stock update events
        document.addEventListener('stockUpdated', function (e) {
            loadCart();
        });
    });

    async function loadCart() {
        try {
            const cart = await CartModule.loadCart();
            renderCart(cart);
        } catch (error) {
            console.error('Error loading cart:', error);
            document.getElementById('cartItemsContainer').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to load cart. Please try again.
                </div>
            `;
        }
    }

    function renderCart(cart) {
        const container = document.getElementById('cartItemsContainer');
        
        // Handle different response structures
        const items = cart.items || cart.results || [];

        if (!items || items.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
                    <h4 class="mt-3">Your cart is empty</h4>
                    <p class="text-muted">Add some products to get started!</p>
                    <a href="/products/" class="btn btn-primary mt-3">
                        <i class="bi bi-shop me-2"></i>Browse Products
                    </a>
                </div>
            `;
            document.getElementById('checkoutBtn').disabled = true;
            return;
        }

        let html = '<div class="table-responsive"><table class="table align-middle">';
        html += '<thead><tr><th>Product</th><th>Price</th><th>Quantity</th><th>Total</th><th>Action</th></tr></thead>';
        html += '<tbody>';

        items.forEach(item => {
            // Use the enhanced variant_details from the new serializer
            const details = item.variant_details;
            const productName = details.product_name || 'Unknown Product';
            const fabricName = details.fabric_name || 'Unknown';
            const colorName = details.color_name || 'Unknown';
            const sizeCode = details.size_code || 'Unknown';
            const price = parseFloat(details.final_price || 0);
            const total = price * item.quantity;
            const stock = details.stock_available || 0;
            const images = details.product_images || [];

            // Show warning if quantity exceeds stock
            const stockWarning = item.quantity > stock ?
                `<small class="text-danger d-block mt-1"><i class="bi bi-exclamation-triangle"></i> Insufficient stock!</small>` : '';

            html += `
                <tr data-item-id="${item.id}" data-variant-size-id="${item.variant_size}">
                    <td>
                        <div class="d-flex align-items-center">
                            ${images && images.length > 0 ?
                    `<img src="${images[0].image_url}" alt="${productName}" 
                                      class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover;">` :
                    `<div class="bg-secondary rounded me-3 d-flex align-items-center justify-content-center" 
                                      style="width: 80px; height: 80px;">
                                    <i class="bi bi-image text-white"></i>
                                 </div>`
                }
                            <div>
                                <h6 class="mb-1">${productName}</h6>
                                <small class="text-muted">
                                    ${fabricName} - ${colorName}<br>
                                    Size: ${sizeCode}
                                </small>
                            </div>
                        </div>
                    </td>
                    <td>${CartModule.formatPrice(price)}</td>
                    <td>
                        <div class="input-group" style="width: 130px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button" 
                                    onclick="updateQuantity(${item.id}, ${item.quantity - 1}, ${stock})">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="form-control form-control-sm text-center" 
                                   value="${item.quantity}" min="1" max="${stock}"
                                   onchange="updateQuantity(${item.id}, this.value, ${stock})"
                                   data-item-id="${item.id}">
                            <button class="btn btn-outline-secondary btn-sm" type="button" 
                                    onclick="updateQuantity(${item.id}, ${item.quantity + 1}, ${stock})">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">${stock} available</small>
                        ${stockWarning}
                    </td>
                    <td><strong>${CartModule.formatPrice(total)}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})" 
                                title="Remove item">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';

        // Add clear cart button
        html += `
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-outline-danger" onclick="clearCart()">
                    <i class="bi bi-trash me-2"></i>Clear Cart
                </button>
            </div>
        `;

        container.innerHTML = html;

        // Update summary
        updateSummary(cart);
        document.getElementById('checkoutBtn').disabled = false;
    }

    function updateSummary(cart) {
        const totals = CartModule.calculateCartTotals(cart);

        document.getElementById('cartSubtotal').textContent = CartModule.formatPrice(totals.subtotal);
        document.getElementById('cartTax').textContent = CartModule.formatPrice(totals.tax);
        document.getElementById('cartTotal').textContent = CartModule.formatPrice(totals.total);
    }

    async function updateQuantity(itemId, newQuantity, maxStock) {
        try {
            await CartModule.updateCartItem(itemId, newQuantity, maxStock);
            loadCart();
        } catch (error) {
            console.error('Error updating quantity:', error);
            loadCart();
        }
    }

    async function removeItem(itemId) {
        const removed = await CartModule.removeCartItem(itemId);
        if (removed) {
            loadCart();
        }
    }

    async function clearCart() {
        const cleared = await CartModule.clearCart();
        if (cleared) {
            loadCart();
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function () {
        CartModule.stopStockMonitoring();
    });
</script>
{% endblock %}